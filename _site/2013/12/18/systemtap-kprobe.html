<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]-->

    <title>SystemTap Kprobe原理</title>
    <meta name="description" content="">

    <link rel="stylesheet" type="text/css" href="/assets/css/style.css">
  </head>
  <body>
    <aside id="sidebar">
      <nav id="tags">
        <a href="/index.html" id="avatar"></a>

        <ul id="tags__ul">
		  <li id="js-label1" class="tags__li tags-btn active">全部文章</li>
		  <li id="js-label2" class="tags__li tags-btn">Kernel内核</li>
          <li id="js-label3" class="tags__li tags-btn">JOS</li>
          <li id="js-label4" class="tags__li tags-btn">Qt</li>
          <li id="js-label5" class="tags__li tags-btn">Grammer</li>
          <li id="js-label6" class="tags__li tags-btn">读书笔记</li>
        </ul>

        <div id="tags__bottom">
          <a href="mailto:ldm5235@gmail.com" id="icon-email" class="tags-btn fontello"></a>
          <a href="/rss.xml" id="icon-feed" class="tags-btn fontello"></a>
        </div>
      </nav> <!-- end #tags -->

      <div id="posts-list">
        <form action="" id="search-form">
          <a href="/index.html" id="mobile-avatar"></a>
          <!-- NOTE: input field is disabled by default -->
          <input id="search-input" type="text" placeholder="Search...">
        </form>

        <nav id="pl__container">
        
          <a class="designpattern pl__all" href="/2014/06/06/Strategy-Pattern-with-c.html"><span class="pl__circle"></span><span class="pl__title">Strategy Pattern with C++</span><span class="pl__date">Jun 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/06/03/decorator-pattern-with-c.html"><span class="pl__circle"></span><span class="pl__title">Decorator Pattern with C++</span><span class="pl__date">Jun 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/06/03/commander-pattern-and-chain-of-responsibility-pattern-with-c.html"><span class="pl__circle"></span><span class="pl__title">Commander Pattern and Chain of Responsibility Pattern with C++</span><span class="pl__date">Jun 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/05/22/mediatorc.html"><span class="pl__circle"></span><span class="pl__title">Mediator模式C++实现</span><span class="pl__date">May 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/05/19/proxyc.html"><span class="pl__circle"></span><span class="pl__title">Proxy模式C++实现</span><span class="pl__date">May 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/05/19/protype_iteratorc.html"><span class="pl__circle"></span><span class="pl__title">Protype_IteratorC++实现</span><span class="pl__date">May 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/05/13/template_builder_designpattern.html"><span class="pl__circle"></span><span class="pl__title">Template_Builder_DesignPattern</span><span class="pl__date">May 2014</span></a>
        
          <a class="linux pl__all" href="/2014/05/07/unix_thread_api.html"><span class="pl__circle"></span><span class="pl__title">Unix_Thread_API备注</span><span class="pl__date">May 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/05/03/factory_designpattern.html"><span class="pl__circle"></span><span class="pl__title">Factory_DesignPattern</span><span class="pl__date">May 2014</span></a>
        
          <a class="linux pl__all" href="/2014/04/14/ram_management3.html"><span class="pl__circle"></span><span class="pl__title">RAM_Management3个层次的关系</span><span class="pl__date">Apr 2014</span></a>
        
          <a class="linux pl__all" href="/2014/04/14/linux-vm.html"><span class="pl__circle"></span><span class="pl__title">Linux VM虚拟存储器系统（读书笔记）</span><span class="pl__date">Apr 2014</span></a>
        
          <a class="jos pl__all" href="/2014/04/09/jospriorityrr_sched.html"><span class="pl__circle"></span><span class="pl__title">在JOS上实现基于Priority的RR_sched</span><span class="pl__date">Apr 2014</span></a>
        
          <a class="linux pl__all" href="/2014/04/08/systemcall.html"><span class="pl__circle"></span><span class="pl__title">Systemcall流程</span><span class="pl__date">Apr 2014</span></a>
        
          <a class="language pl__all" href="/2014/03/30/markdown-grammer.html"><span class="pl__circle"></span><span class="pl__title">Markdown grammer</span><span class="pl__date">Mar 2014</span></a>
        
          <a class="jos pl__all" href="/2014/03/26/idtmd.html"><span class="pl__circle"></span><span class="pl__title">设定IDT表以及中断处理函数编写</span><span class="pl__date">Mar 2014</span></a>
        
          <a class="linux pl__all" href="/2014/03/13/interrupt.html"><span class="pl__circle"></span><span class="pl__title">异常控制流（读书笔记）</span><span class="pl__date">Mar 2014</span></a>
        
          <a class="jos pl__all" href="/2014/03/10/jos.html"><span class="pl__circle"></span><span class="pl__title">JOS虚拟页表的实现</span><span class="pl__date">Mar 2014</span></a>
        
          <a class="jos pl__all" href="/2014/03/04/jos.html"><span class="pl__circle"></span><span class="pl__title">JOS的物理页表分配实现</span><span class="pl__date">Mar 2014</span></a>
        
          <a class="jos pl__all" href="/2014/02/24/frame-info.html"><span class="pl__circle"></span><span class="pl__title">打印Frame Info</span><span class="pl__date">Feb 2014</span></a>
        
          <a class="linux pl__all" href="/2014/01/03/linux.html"><span class="pl__circle"></span><span class="pl__title">Linux系统调用（读书笔记）</span><span class="pl__date">Jan 2014</span></a>
        
          <a class="linux pl__all" href="/2013/12/18/systemtap-kprobe.html"><span class="pl__circle"></span><span class="pl__title">SystemTap Kprobe原理</span><span class="pl__date">Dec 2013</span></a>
        
          <a class="linux pl__all" href="/2013/12/11/kernel-development.html"><span class="pl__circle"></span><span class="pl__title">内核开发特点&进程管理（读书笔记）</span><span class="pl__date">Dec 2013</span></a>
        
          <a class="arch pl__all" href="/2013/12/10/storage.html"><span class="pl__circle"></span><span class="pl__title">Storage层次结构（读书笔记）</span><span class="pl__date">Dec 2013</span></a>
        
          <a class="arch pl__all" href="/2013/12/04/cpu.html"><span class="pl__circle"></span><span class="pl__title">CPU指令并行化（读书笔记）</span><span class="pl__date">Dec 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/29/gprof-.html"><span class="pl__circle"></span><span class="pl__title">GPROF 使用</span><span class="pl__date">Nov 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/28/programme_opinion.html"><span class="pl__circle"></span><span class="pl__title">programme_opinion（读书笔记）</span><span class="pl__date">Nov 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/22/share-object-library.html"><span class="pl__circle"></span><span class="pl__title">编写Share Object Library</span><span class="pl__date">Nov 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/22/ltrace-strace-ftrace.html"><span class="pl__circle"></span><span class="pl__title">调试工具ltrace strace ftrace的使用</span><span class="pl__date">Nov 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/13/linux-kernel.html"><span class="pl__circle"></span><span class="pl__title">裁剪编译Linux Kernel</span><span class="pl__date">Nov 2013</span></a>
        
        </nav>
      </div> <!-- end #posts-list -->
    </aside> <!-- end #sidebar -->

    <div id="post">
      <div id="pjax">
        <article id="post__content">
  <h1 id="post__title" data-identifier="20131218">SystemTap Kprobe原理</h1>
  <h1>SystemTap Kprobe原理</h1>

<p>想写这篇文章好长时间了，一直没有来得及总结，今天我把这个坑填上！</p>

<p>Systemtap是一种动态调试内核的工具，可以极大地方便内核开发人员对于内核的调试，过去，内核想要调试，必须在源码中打入print（）然后进行编译，安装内核重启，这个导致内核调试复杂。</p>

<p>现在我们可以使用systemtap中的kprobe编写脚本，然后使用stap命令进行编译，即可对内核中的变量函数进行调试。</p>

<p>Systemtap 是基于kprobes 机制实现探测的，即最终使用了kprobe 提供的接口。从kprobe原理可知，对于每一个探针来说，用户需要定义探测点和相应的处理函数。探测点是指kprobe 机制中的被探测函数或者指令地址（亦可称为内核事件），但对于Systemtap 来讲，用户可以指定源码文件、源代码中的某一行，用户也可以指定一个异步事件，比如周期性的定时器。除了Kprobes 之外，还使用了kernel markers 技术，现已被tracepoints 技术替代。</p>

<p>Systemtap 的基本处理流程如图所示，该过程涉及5 个阶段，并且包括3 个具有交互关系的实用程序(stap、staprun、stapio)。</p>

<p>输入：</p>

<p>▶ script.stp –> 普通用户编写</p>

<p>▶ tapset(由脚本语言或C 语言编写) –> 内核开发者编写</p>

<p>▶ DWARF(内核编译时产生的调试信息) –> 内核编译时产生，这里我们要声明一下产生debuginfo的前提是在编译kernel时候勾选debuginfo选项</p>

<p>▶ 运行时库</p>

<p>输出：内核模块</p>

<p><img src="/assets/pic/4058.png" alt="" /></p>

<p><img src="/assets/pic/4227.png" alt="" /></p>

<p>从上面的图，我们可以清楚地看到kprobe的五个阶段：</p>

<blockquote><p>Pass 1(parse)：stap 将脚本转换为语法分析树，并检查语法错误。</p>

<p>Pass 2(elaborate)：1) 从脚本库中添加相应的代码；2) 从当前正在运行的内核的调试信息中获取探测点以及变量的位置。</p>

<p>Pass 3(translate)：将第二阶段的输出翻译成C 文件，在该阶段Systemtap 将根据需要增加必要的锁和安全检查代码。</p>

<p>Pass 4(Build)：该阶段是“stap”的最后一步，该阶段主要是构造相应的内核模块，同时需要链接相应的运行时库（runtime libraries）。内核模块的后缀名都是以.ko结尾。</p>

<p>Pass 5(Execute)：当第四阶段完成之后stap 会生成最终可执行的内核模块，此时stap 也就完成了自己的任务，并将控制权交给Systemtap 的其他两个实用程序：staprun(/usr/bin, 通常可stap 在同一个目录中) 和stapio（/usr/libexec/systemtap），它们负载加载内核模块以及输出探测信息等。</p></blockquote>

<p>这里面我要说明一下/usr/bin/staprun可以用户调用，/usr/libexec/systemtap/stapio无法用户调用！</p>

<p>另外我从一个论文里看到一幅特别好的示例图，可以给大家分享一下！</p>

<p><img src="/assets/pic/4524.png" alt="" /></p>

<p>这幅图，很清晰的标出了每个阶段链接了哪些库，对我们理解systemtap原理有很大的帮助！</p>

<p>Kprobe的原理其实和GDB原理很像，都是调用INT 3中断然后跳转到特定的arch/x86/kernel/kprobes.c中的handler</p>

<p><img src="/assets/pic/0006.png" alt="" /></p>

</article> <!-- end #post__content -->

<div id="post__share">
  <a id="icon-twitter" class="fontello" href="https://twitter.com/intent/tweet?url=http://lzz5235.github.com/2013/12/18/systemtap-kprobe.html&text=SystemTap Kprobe原理" target="_blank"></a>
  <a id="icon-cc" class="fontello" href="http://creativecommons.org/licenses/by-nc-sa/3.0" target="_blank"></a>
  <a id="icon-weibo" class="fontello" href="http://v.t.sina.com.cn/share/share.php?url=http://lzz5235.github.com/2013/12/18/systemtap-kprobe.html&title=SystemTap Kprobe原理" target="_blank"></a>
</div> <!-- end #post__share -->

<div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink" target="_blank">Loading Disqus comments...</a>
</div> <!-- end #disqus_thread -->

<p id="copyright">Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;&nbsp;|&nbsp;&nbsp;Theme <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll</a>&nbsp;&nbsp;Fork My <a href="https://github.com/lzz5235" target="_blank">Github</a></p>

      </div> <!-- end #pjax -->

      <div id="post__toc-trigger">
        <div id="post__toc">
          <span id="post__toc-title">Table of Contents</span>
          <ul id="post__toc-ul"></ul>
        </div>
      </div>
    </div> <!-- end #post -->

    <button id="js-fullscreen"><span id="icon-arrow" class="fontello"></span></button>

    <script src="/assets/js/jquery-2.0.3.min.js"></script>
    <script src="/assets/js/jquery.pjax.js"></script>
    <script src="/assets/js/nprogress.js"></script>
    <script src="/assets/js/script.js"></script>
  </body>
</html>
