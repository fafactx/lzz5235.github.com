<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]-->

    <title>Kernel Timer Manager</title>
    <meta name="author" content="JasonLe">

    <link rel="stylesheet" type="text/css" href="/assets/css/style.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/prism.css"> 
  </head>
  <body>
    <aside id="sidebar">
      <nav id="tags">
        <a href="/index.html" id="avatar"></a>

        <ul id="tags__ul">
		  <li id="js-label1" class="tags__li tags-btn active">全部文章</li>
		  <li id="js-label2" class="tags__li tags-btn">Linux</li>
          <li id="js-label3" class="tags__li tags-btn">JOS</li>
          <li id="js-label4" class="tags__li tags-btn">DesginPattern</li>
          <li id="js-label5" class="tags__li tags-btn">读书笔记</li>
          <li id="js-label6" class="tags__li tags-btn">杂谈</li>
        </ul>
<!--
        <div id="tags__bottom">
          <a href="mailto:ldm5235@gmail.com" id="icon-email" class="tags-btn fontello"></a>
          <a href="/rss.xml" id="icon-feed" class="tags-btn fontello"></a>
        </div>
  -->      
      </nav> <!-- end #tags -->

      <div id="posts-list">
         
          <form action="#" id="search-form">
          <!-- NOTE: input field is disabled by default -->
          <input id="search-input" type="text" placeholder="" disabled="" >
          </form>

        <nav id="pl__container">
        
          <a class="designpattern pl__all" href="/2014/07/23/construction-designpattern-comparison.html" title="Construction DesignPattern Comparison"><span class="pl__circle"></span><span class="pl__title">
          
          Construction DesignPat...
          
          </span><span class="pl__date">Jul 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/07/15/statepattern-with-c.html" title="StatePattern with C++"><span class="pl__circle"></span><span class="pl__title">
          
          StatePattern with C++
          
          </span><span class="pl__date">Jul 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/07/14/create-design-pattern-comparison.html" title="Create Design Pattern Comparison"><span class="pl__circle"></span><span class="pl__title">
          
          Create Design Pattern ...
          
          </span><span class="pl__date">Jul 2014</span></a>
        
          <a class="others pl__all" href="/2014/07/11/the-keynote-of-data-mining-by-myself.html" title="The Keynote of Data Mining by myself"><span class="pl__circle"></span><span class="pl__title">
          
          The Keynote of Data Mi...
          
          </span><span class="pl__date">Jul 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/06/20/flyweight-pattern-with-c.html" title="Flyweight Pattern with C++"><span class="pl__circle"></span><span class="pl__title">
          
          Flyweight Pattern with...
          
          </span><span class="pl__date">Jun 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/06/19/bridge-pattern-with-c.html" title="Bridge Pattern with C++"><span class="pl__circle"></span><span class="pl__title">
          
          Bridge Pattern with C++
          
          </span><span class="pl__date">Jun 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/06/17/visitor-pattern-with-c.html" title="Visitor Pattern with C++"><span class="pl__circle"></span><span class="pl__title">
          
          Visitor Pattern with C++
          
          </span><span class="pl__date">Jun 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/06/12/memento-pattern-with-c.html" title="Memento Pattern with C++"><span class="pl__circle"></span><span class="pl__title">
          
          Memento Pattern with C++
          
          </span><span class="pl__date">Jun 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/06/10/observer-pattern-with-c.html" title="Observer Pattern with C++"><span class="pl__circle"></span><span class="pl__title">
          
          Observer Pattern with C++
          
          </span><span class="pl__date">Jun 2014</span></a>
        
          <a class="jos pl__all" href="/2014/06/08/user-excption-stack-design.html" title="User Excption Stack Design"><span class="pl__circle"></span><span class="pl__title">
          
          User Excption Stack De...
          
          </span><span class="pl__date">Jun 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/06/06/Strategy-Pattern-with-c.html" title="Strategy Pattern with C++"><span class="pl__circle"></span><span class="pl__title">
          
          Strategy Pattern with C++
          
          </span><span class="pl__date">Jun 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/06/03/decorator-pattern-with-c.html" title="Decorator Pattern with C++"><span class="pl__circle"></span><span class="pl__title">
          
          Decorator Pattern with...
          
          </span><span class="pl__date">Jun 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/06/03/commander-pattern-and-chain-of-responsibility-pattern-with-c.html" title="Commander Pattern and Chain of Responsibility Pattern with C++"><span class="pl__circle"></span><span class="pl__title">
          
          Commander Pattern and ...
          
          </span><span class="pl__date">Jun 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/05/22/mediatorc.html" title="Mediator模式C++实现"><span class="pl__circle"></span><span class="pl__title">
          
          Mediator模式C++实现
          
          </span><span class="pl__date">May 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/05/19/proxyc.html" title="Proxy模式C++实现"><span class="pl__circle"></span><span class="pl__title">
          
          Proxy模式C++实现
          
          </span><span class="pl__date">May 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/05/19/protype_iteratorc.html" title="Protype_IteratorC++实现"><span class="pl__circle"></span><span class="pl__title">
          
          Protype_IteratorC++实现
          
          </span><span class="pl__date">May 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/05/13/template_builder_designpattern.html" title="Template_Builder_DesignPattern"><span class="pl__circle"></span><span class="pl__title">
          
          Template_Builder_Desig...
          
          </span><span class="pl__date">May 2014</span></a>
        
          <a class="linux pl__all" href="/2014/05/07/unix_thread_api.html" title="Unix_Thread_API备注"><span class="pl__circle"></span><span class="pl__title">
          
          Unix_Thread_API备注
          
          </span><span class="pl__date">May 2014</span></a>
        
          <a class="designpattern pl__all" href="/2014/05/03/factory_designpattern.html" title="Factory_DesignPattern"><span class="pl__circle"></span><span class="pl__title">
          
          Factory_DesignPattern
          
          </span><span class="pl__date">May 2014</span></a>
        
          <a class="linux pl__all" href="/2014/04/14/ram_management3.html" title="RAM_Management3个层次的关系"><span class="pl__circle"></span><span class="pl__title">
          
          RAM_Management3个层次的关系
          
          </span><span class="pl__date">Apr 2014</span></a>
        
          <a class="read pl__all" href="/2014/04/14/linux-vm.html" title="Linux VM虚拟存储器系统（读书笔记）"><span class="pl__circle"></span><span class="pl__title">
          
          Linux VM虚拟存储器系统（读书笔记）
          
          </span><span class="pl__date">Apr 2014</span></a>
        
          <a class="jos pl__all" href="/2014/04/09/jospriorityrr_sched.html" title="在JOS上实现基于Priority的RR_sched"><span class="pl__circle"></span><span class="pl__title">
          
          在JOS上实现基于Priority的RR_s...
          
          </span><span class="pl__date">Apr 2014</span></a>
        
          <a class="linux pl__all" href="/2014/04/08/systemcall.html" title="Systemcall流程"><span class="pl__circle"></span><span class="pl__title">
          
          Systemcall流程
          
          </span><span class="pl__date">Apr 2014</span></a>
        
          <a class="others pl__all" href="/2014/03/30/markdown-grammer.html" title="Markdown grammer"><span class="pl__circle"></span><span class="pl__title">
          
          Markdown grammer
          
          </span><span class="pl__date">Mar 2014</span></a>
        
          <a class="jos pl__all" href="/2014/03/26/idtmd.html" title="设定IDT表以及中断处理函数编写"><span class="pl__circle"></span><span class="pl__title">
          
          设定IDT表以及中断处理函数编写
          
          </span><span class="pl__date">Mar 2014</span></a>
        
          <a class="read pl__all" href="/2014/03/13/interrupt.html" title="异常控制流（读书笔记）"><span class="pl__circle"></span><span class="pl__title">
          
          异常控制流（读书笔记）
          
          </span><span class="pl__date">Mar 2014</span></a>
        
          <a class="jos pl__all" href="/2014/03/10/jos.html" title="JOS虚拟页表的实现"><span class="pl__circle"></span><span class="pl__title">
          
          JOS虚拟页表的实现
          
          </span><span class="pl__date">Mar 2014</span></a>
        
          <a class="jos pl__all" href="/2014/03/04/jos.html" title="JOS的物理页表分配实现"><span class="pl__circle"></span><span class="pl__title">
          
          JOS的物理页表分配实现
          
          </span><span class="pl__date">Mar 2014</span></a>
        
          <a class="jos pl__all" href="/2014/02/24/frame-info.html" title="打印Frame Info"><span class="pl__circle"></span><span class="pl__title">
          
          打印Frame Info
          
          </span><span class="pl__date">Feb 2014</span></a>
        
          <a class="read pl__all" href="/2014/01/03/linux.html" title="Linux系统调用（读书笔记）"><span class="pl__circle"></span><span class="pl__title">
          
          Linux系统调用（读书笔记）
          
          </span><span class="pl__date">Jan 2014</span></a>
        
          <a class="linux pl__all" href="/2013/12/24/Kernel-Timer-Manager.html" title="Kernel Timer Manager"><span class="pl__circle"></span><span class="pl__title">
          
          Kernel Timer Manager
          
          </span><span class="pl__date">Dec 2013</span></a>
        
          <a class="linux pl__all" href="/2013/12/18/systemtap-kprobe.html" title="SystemTap Kprobe原理"><span class="pl__circle"></span><span class="pl__title">
          
          SystemTap Kprobe原理
          
          </span><span class="pl__date">Dec 2013</span></a>
        
          <a class="read pl__all" href="/2013/12/11/kernel-development.html" title="内核开发特点&进程管理（读书笔记）"><span class="pl__circle"></span><span class="pl__title">
          
          内核开发特点&进程管理（读书笔记）
          
          </span><span class="pl__date">Dec 2013</span></a>
        
          <a class="read pl__all" href="/2013/12/10/storage.html" title="Storage层次结构（读书笔记）"><span class="pl__circle"></span><span class="pl__title">
          
          Storage层次结构（读书笔记）
          
          </span><span class="pl__date">Dec 2013</span></a>
        
          <a class="read pl__all" href="/2013/12/04/cpu.html" title="CPU指令并行化（读书笔记）"><span class="pl__circle"></span><span class="pl__title">
          
          CPU指令并行化（读书笔记）
          
          </span><span class="pl__date">Dec 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/29/gprof-.html" title="GPROF 使用"><span class="pl__circle"></span><span class="pl__title">
          
          GPROF 使用
          
          </span><span class="pl__date">Nov 2013</span></a>
        
          <a class="read pl__all" href="/2013/11/28/programme_opinion.html" title="programme_opinion（读书笔记）"><span class="pl__circle"></span><span class="pl__title">
          
          programme_opinion（读书笔记）
          
          </span><span class="pl__date">Nov 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/22/share-object-library.html" title="编写Share Object Library"><span class="pl__circle"></span><span class="pl__title">
          
          编写Share Object Library
          
          </span><span class="pl__date">Nov 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/22/ltrace-strace-ftrace.html" title="调试工具ltrace strace ftrace的使用"><span class="pl__circle"></span><span class="pl__title">
          
          调试工具ltrace strace ftra...
          
          </span><span class="pl__date">Nov 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/21/elf.html" title="ELF文件的加载"><span class="pl__circle"></span><span class="pl__title">
          
          ELF文件的加载
          
          </span><span class="pl__date">Nov 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/20/gdb.html" title="使用GDB中修改特定寄存器值及其原理"><span class="pl__circle"></span><span class="pl__title">
          
          使用GDB中修改特定寄存器值及其原理
          
          </span><span class="pl__date">Nov 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/20/gcov.html" title="GCOV的使用"><span class="pl__circle"></span><span class="pl__title">
          
          GCOV的使用
          
          </span><span class="pl__date">Nov 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/13/linux-kernel.html" title="裁剪编译Linux Kernel"><span class="pl__circle"></span><span class="pl__title">
          
          裁剪编译Linux Kernel
          
          </span><span class="pl__date">Nov 2013</span></a>
        
          <a class="linux pl__all" href="/2013/11/01/assemble.html" title="Assemble函数栈帧结构详解"><span class="pl__circle"></span><span class="pl__title">
          
          Assemble函数栈帧结构详解
          
          </span><span class="pl__date">Nov 2013</span></a>
        
          <a class="others pl__all" href="/2013/10/24/cscope-ctags-vim-.html" title="cscope ctags vim 使用"><span class="pl__circle"></span><span class="pl__title">
          
          cscope ctags vim 使用
          
          </span><span class="pl__date">Oct 2013</span></a>
        
          <a class="others pl__all" href="/2013/08/13/static-words.html" title="统计单词出现数目（更新）"><span class="pl__circle"></span><span class="pl__title">
          
          统计单词出现数目（更新）
          
          </span><span class="pl__date">Aug 2013</span></a>
        
          <a class="others pl__all" href="/2013/08/11/do_poineering_work.html" title="一个资深程序员的创业失败经验分享(转)"><span class="pl__circle"></span><span class="pl__title">
          
          一个资深程序员的创业失败经验分享(转)
          
          </span><span class="pl__date">Aug 2013</span></a>
        
        </nav>
      </div> <!-- end #posts-list -->
    </aside> <!-- end #sidebar -->

    <div id="post">
      <div id="pjax">
        <article id="post__content">
  <h1 id="post__title" data-identifier="20131224">Kernel Timer Manager</h1>
  <h1>Kernel中定时器与时间管理</h1>

<p>linux kernel时钟就是系统定时器以某种频率自行触发，当时钟中断发生时，内核就通过一种特殊的中断处理程序对其进行处理。</p>

<p>利用时钟中断做的事情：</p>

<ol>
<li>更新系统运行时间 update_wall_time(ticks)</li>
<li>更新实际时间</li>
<li>在SMP系统上，均衡调度各处理器上的运行队列</li>
<li>检查自己时间片是否用尽，耗尽的花，就是用schedule（）调度</li>
<li>更新资源消耗负载，比如top右上方统计值</li>
</ol>


<p>在include/asm-generic/param.h 规定了节拍值。</p>

<p>比如HZ定义的是1000Hz   也就意味着1/1000 s中断一次，除此之外还有USER_HZ这个是在用户空间下使用的，二者相同。</p>

<p>不同的HZ有不同的优缺点，较高的HZ可以对poll（）select（）超时精度的提高，会对系统性能提高带来极大好处。较高的HZ=1000可以使得一个正在运行的程序即使只有2ms时间片，也可以尽快调度。但是HZ=100的话，程序只有在10ms后才可以调度。</p>

<p>jiffies定义在include/linux/jiffies.h中</p>

<pre><code>
extern unsigned long volatile jiffies
</code></pre>


<p>在32位机上市32位，64位机是64位。有时候我们不care高位，所以我们使用强转。C语言限定符volatile表示jiffies是一个易该变的变量，因此编译器将使对该变量的访问从不通过CPU内部cache来进行。</p>

<pre><code>
* The 64-bit value is not atomic - you MUST NOT read it
 * without sampling the sequence number in jiffies_lock.
* get_jiffies_64() will do this for you as appropriate.
*
extern u64 __jiffy_data jiffies_64;
extern unsigned long volatile __jiffy_data jiffies;
#if (BITS_PER_LONG &lt; 64)
u64 get_jiffies_64(void);
#else
static inline u64 get_jiffies_64(void)
{
   return (u64)jiffies;
}
#endif
</code></pre>


<p>要记住，这个数字只要kernel初始化后，就开始一直自增。所以很有可能溢出，在&lt;linux/jiffies.h>中定义了比较时间的宏，防止了jiffies值得溢出。</p>

<p>全局变量xtime：它是一个timeval结构类型的变量，用来表示当前时间距UNIX时间基准1970－01－01 00：00：00的相对秒数值。结构timeval是Linux内核表示时间的一种格式（Linux内核对时间的表示有多种格式，每种格式都有不同的时间精度），其时间精度是微秒。</p>

<pre><code>
#ifndef _STRUCT_TIMESPEC
#define _STRUCT_TIMESPEC
struct timespec {
    __kernel_time_t tv_sec;         /* seconds */
    long        tv_nsec;        /* nanoseconds */
};
#endif
struct timeval {
    __kernel_time_t     tv_sec;     /* seconds */
    __kernel_suseconds_t    tv_usec;    /* microseconds */
};
struct timezone {
    int tz_minuteswest; /* minutes west of Greenwich */
    int tz_dsttime; /* type of dst correction */
};
</code></pre>


<p>时钟中断服务程序主要是调用do_timer（），首先进行jiffies_64++,然后调用update_process_times()；update_times（）</p>

<h5>对于实际时间，更新xtime我们要使用seqlock锁。</h5>

<p>seqlock的实现思路是，用一个递增的整型数表示sequence。写操作进入临界区时，sequence++；退出临界区时，sequence再++。写操作还需要获得一个锁（比如mutex），这个锁仅用于写写互斥，以保证同一时间最多只有一个正在进行的写操作。</p>

<p>当sequence为奇数时，表示有写操作正在进行，这时读操作要进入临界区需要等待，直到sequence变为偶数。读操作进入临界区时，需要记录下当前sequence的值，等它退出临界区的时候用记录的sequence与当前sequence做比较，不相等则表示在读操作进入临界区期间发生了写操作，这时候读操作读到的东西是无效的，需要返回重试。</p>

<p>seqlock写写是必须要互斥的。但是seqlock的应用场景本身就是读多写少的情况，写冲突的概率是很低的。所以这里的写写互斥基本上不会有什么性能损失。
而读写操作是不需要互斥的。seqlock的应用场景是写操作优先于读操作，</p>

<pre><code>
write_seqlock(&xtime_lock);
..............
write_sequnlock(&xtime_lock)；
//读
do
{
      seq = read_seqbegin(&seq_lock);      // 进入临界区
      do_something();
} while (read_seqretry(&seq_lock, seq)); // 尝试退出临界区，存在冲突则重试
从内核空间取得时间的函数式sys_gettimeofday（）.从用户空间获取时间是gettimeofday（）.
</code></pre>


<h6>定时器也是内核编程中的比较重要的一个项目，timer_list的定义在include/linux/timer.h</h6>

<pre><code>
struct timer_list 
{
    struct list_head entry;
    unsigned long expires;
    struct tvec_base *base;
 
    void (*function)(unsigned long);
    unsigned long data;
 
    int slack;
 
#ifdef CONFIG_TIMER_STATS
    int start_pid;
    void *start_site;
    char start_comm[16];
#endif
#ifdef CONFIG_LOCKDEP
    struct lockdep_map lockdep_map;
#endif
};
</code></pre>


<p>使用timer比较简单</p>

<ol>
<li>struct timer_list my_timer;</li>
<li>init_timer(&amp;my_timer);</li>
<li>填充my_timer     data，expires = jiffies+delay，function</li>
<li>定义自己的My_timer_function()</li>
<li>add_timer(&amp;my_timer)；mod_timer（）；del_timer（）</li>
</ol>


<h5>要区分del_timer（）在SMP环境下会出现在别的CPU上运行。用del_timer_sync()解决，但不能再中断上下文中运行。</h5>

<h5>短延迟使用linux/delay.h中的void udelay（）与void mdelay（）.</h5>

<h5>如果长延迟，让任务在我们规定的时刻wakeup就使用schedule_timeout()</h5>

<p>参考：
<a href="http://blog.csdn.net/axman/article/details/8484583]">http://blog.csdn.net/axman/article/details/8484583</a></p>

<p><a href="http://www.ibm.com/developerworks/cn/linux/1307_liuming_linuxtime1/">http://www.ibm.com/developerworks/cn/linux/1307_liuming_linuxtime1/</a></p>

</article> <!-- end #post__content -->

<div id="post__share">
  <a id="icon-twitter" class="fontello" href="https://twitter.com/intent/tweet?url=http://lzz5235.github.com/2013/12/24/Kernel-Timer-Manager.html&text=Kernel Timer Manager" target="_blank"></a>
  <a id="icon-cc" class="fontello" href="http://creativecommons.org/licenses/by-nc-sa/3.0" target="_blank"></a>
  <a id="icon-weibo" class="fontello" href="http://v.t.sina.com.cn/share/share.php?url=http://lzz5235.github.com/2013/12/24/Kernel-Timer-Manager.html&title=Kernel Timer Manager" target="_blank"></a>
</div> <!-- end #post__share -->

<div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink" target="_blank">Loading Disqus comments...</a>
</div> <!-- end #disqus_thread -->

<p id="copyright">Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;&nbsp;|&nbsp;&nbsp;Theme <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll</a>&nbsp;&nbsp;Fork My <a href="https://github.com/lzz5235" target="_blank">Github</a></p>

      </div> <!-- end #pjax -->

      <div id="post__toc-trigger">
        <div id="post__toc">
          <span id="post__toc-title">目录导航</span>
          <ul id="post__toc-ul"></ul>
        </div>
      </div>
    </div> <!-- end #post -->

    <button id="js-fullscreen"><span id="icon-arrow" class="fontello"></span></button>
    <a id="scrollUp" href="javascript:void(0);" title="" style="position: fixed; z-index: 2147483647; display: none;"></a>
   
    <script src="/assets/js/jquery-2.0.3.min.js"></script>
    <script src="/assets/js/jquery.pjax.js"></script>
    <script src="/assets/js/nprogress.js"></script>
    <script src="/assets/js/script.js"></script>
   <!--
    <script src="/assets/js/prism.js"></script>
    -->
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-51310656-1', 'lzz5235.github.io');
    ga('send', 'pageview');

  </script>
  </body>
</html>
